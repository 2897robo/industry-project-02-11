#!/bin/bash

echo "ğŸ”§ Gradle Wrapper ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸"
echo "=============================="

PROJECT_ROOT=$(pwd)

# Gradle wrapper íŒŒì¼ ë‚´ìš©
create_gradle_wrapper() {
    local SERVICE_DIR=$1
    
    # gradle/wrapper ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p "$SERVICE_DIR/gradle/wrapper"
    
    # gradle-wrapper.properties ìƒì„±
    cat > "$SERVICE_DIR/gradle/wrapper/gradle-wrapper.properties" << 'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.13-bin.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
    
    # gradlew ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
    cat > "$SERVICE_DIR/gradlew" << 'EOF'
#!/bin/sh

##############################################################################
#
#   Gradle start up script for POSIX generated by Gradle.
#
##############################################################################

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
app_path=$0

# Follow symlinks
while [ -h "$app_path" ]; do
    ls=$(ls -ld "$app_path")
    link=$(expr "$ls" : '.*-> \(.*\)$')
    if expr "$link" : '/.*' > /dev/null; then
        app_path=$link
    else
        app_path=$(dirname "$app_path")/$link
    fi
done

# Get standard environment variables
APP_NAME=$(basename "$0")
APP_BASE_NAME=$(basename "$0" .sh)
APP_HOME=$(cd "$(dirname "$0")" && pwd)

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD=maximum

# OS specific support
cygwin=false
msys=false
darwin=false
nonstop=false
case "$(uname)" in
    CYGWIN*) cygwin=true;;
    Darwin*) darwin=true;;
    MINGW*) msys=true;;
    NONSTOP*) nonstop=true;;
esac

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar

# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ]; then
    JAVACMD=$JAVA_HOME/bin/java
else
    JAVACMD=java
fi

# Increase the maximum file descriptors if we can.
if [ "$darwin" = false ] && [ "$nonstop" = false ]; then
    case $MAX_FD in
        max*)
            MAX_FD=$(ulimit -H -n) || true
        ;;
    esac
fi

# Collect JVM options
JVM_OPTS=

# Execute Gradle
exec "$JAVACMD" $JVM_OPTS \
    -classpath "$CLASSPATH" \
    org.gradle.wrapper.GradleWrapperMain \
    "$@"
EOF
    
    # ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
    chmod +x "$SERVICE_DIR/gradlew"
    
    echo "âœ… $SERVICE_DIR: Gradle Wrapper ìƒì„± ì™„ë£Œ"
}

# ê° ì„œë¹„ìŠ¤ì— ëŒ€í•´ Gradle Wrapper ìƒì„±
for service in eureka-discovery-service gateway-service auth-service user-service backend; do
    SERVICE_DIR="$PROJECT_ROOT/apps/$service"
    if [ -d "$SERVICE_DIR" ]; then
        echo "ì²˜ë¦¬ ì¤‘: $service"
        create_gradle_wrapper "$SERVICE_DIR"
        
        # gradle-wrapper.jar ë‹¤ìš´ë¡œë“œ
        cd "$SERVICE_DIR"
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "gradle-wrapper.jar ë‹¤ìš´ë¡œë“œ ì¤‘..."
            curl -L https://github.com/gradle/gradle/raw/v8.13.0/gradle/wrapper/gradle-wrapper.jar \
                 -o gradle/wrapper/gradle-wrapper.jar
        fi
        cd "$PROJECT_ROOT"
    fi
done

echo ""
echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ì˜ Gradle Wrapperê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
echo ""
echo "ì´ì œ ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì„œë¹„ìŠ¤ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:"
echo "  ./start-all-services.sh"
